---
import Icon from "@/components/Icon.astro";

// Mapeo de iconos del sprite
const iconNames = {
  fire: 'flame',
  ruler: 'ruler',
  wrench: 'corkscrew',
  gear: 'settings',
  shield: 'shield-check',
  camera: 'clapperboard-play',
  map: 'point-on-map',
  ladder: 'alt-arrow-up',
  signal: 'heart-pulse',
  eye: 'eye',
};

// Initial data for server-side rendering (defaulting to Fire)
const steps = [
  {
    id: 1,
    label: 'Consulta',
    description: 'Análisis inicial de necesidades',
    iconName: iconNames.fire,
    x: 10,
    y: 0,
    badgeAngle: 45,
    position: "bottom"
  },
  {
    id: 2,
    label: 'Diseño',
    description: 'Planificación del sistema',
    iconName: iconNames.ruler,
    x: 30,
    y: 50,
    badgeAngle: 285,
    position: "bottom"
  },
  {
    id: 3,
    label: 'Instalación',
    description: 'Montaje de equipos',
    iconName: iconNames.wrench,
    x: 50,
    y: 20,
    badgeAngle: 90,
    position: "top"
  },
  {
    id: 4,
    label: 'Config',
    description: 'Configuración y pruebas',
    iconName: iconNames.gear,
    x: 70,
    y: 50,
    badgeAngle: 225,
    position: "bottom"
  },
  {
    id: 5,
    label: 'Monitoreo',
    description: 'Supervisión continua',
    iconName: iconNames.shield,
    x: 90,
    y: 0,
    badgeAngle: 135,
    position: "bottom"
  }
];

// Configuration for calculations
const containerWidth = 1200;
const containerHeight = 600;
const circleRadius = 64; 
const badgeOffset = circleRadius; 

const pathPoints = steps.map(step => {
  const cx = (step.x / 100) * containerWidth;
  const cy = (step.y / 100) * containerHeight;
  const angleRad = (step.badgeAngle * Math.PI) / 180;
  const bx = cx + (badgeOffset * Math.cos(angleRad));
  const by = cy + (badgeOffset * Math.sin(angleRad));
  return { x: bx, y: by };
});

const pathSegments = [];
for (let i = 0; i < pathPoints.length - 1; i++) {
  const p1 = pathPoints[i];
  const p2 = pathPoints[i+1];
  const d = `M ${p1.x} ${p1.y} Q ${(p1.x + p2.x)/2} ${(p1.y + p2.y)/2 + (i % 2 === 0 ? 50 : -50)}, ${p2.x} ${p2.y}`;
  pathSegments.push(d);
}
---

<section class="pt-20 overflow-hidden relative" id="how-to-work">
  <!-- Malla decorativa - esquina inferior izquierda -->
  <svg class="absolute bottom-0 left-0 w-64 h-64 opacity-20 pointer-events-none z-0" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <pattern id="grid-left" width="20" height="20" patternUnits="userSpaceOnUse">
        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#DC143C" stroke-width="0.5"/>
      </pattern>
    </defs>
    <rect width="200" height="200" fill="url(#grid-left)" />
  </svg>

  <!-- Malla decorativa - esquina inferior derecha -->
  <svg class="absolute bottom-0 right-0 w-64 h-64 opacity-20 pointer-events-none z-0" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <pattern id="grid-right" width="20" height="20" patternUnits="userSpaceOnUse">
        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#DC143C" stroke-width="0.5"/>
      </pattern>
    </defs>
    <rect width="200" height="200" fill="url(#grid-right)" />
  </svg>

  <div class="max-w-7xl mx-auto px-4 relative z-10">
    
    <!-- Header -->
    <div class="text-center mb-12">
    
      <h2 class="font-display text-3xl md:text-6xl font-bold text-gray-900 mb-8">Como trabajamos</h2>
      
      <!-- Tabs -->
      <div class="flex justify-center gap-4 mb-12">
        <button
          class="tab-btn active px-8 py-2 rounded-[20px] cursor-pointer font-bold text-lg transition-all duration-300 border-2 border-indian-red-500 bg-indian-red-500 text-white shadow-lg hover:border-indian-red-500 hover:text-indian-red-500 flex items-center gap-2"
          data-type="fire"
        >
          <Icon name="flame" size="20" />
          <span>Alarmas de Fuego</span>
        </button>
        <button
          class="tab-btn px-8 py-2 rounded-[20px] cursor-pointer font-bold text-lg transition-all duration-300 border-2 border-gray-200 bg-white text-gray-500 hover:border-indian-red-500 hover:text-indian-red-500 flex items-center gap-2"
          data-type="video"
        >
          <Icon name="clapperboard-play" size="20" />
          <span>Video Vigilancia</span>
        </button>
      </div>
    </div>

    <!-- Diagram Container -->
    <div class="relative h-[600px] md:block w-full max-w-[1200px] mx-auto">

      <!-- SVG Connecting Line -->
      <svg class="absolute top-0 left-0 w-full h-full z-0 pointer-events-none" viewBox="0 0 1200 600" preserveAspectRatio="xMidYMid meet">
        <defs>
          {pathSegments.map((d, index) => (
            <mask id={`mask-line-${index}`}>
              <path 
                d={d} 
                stroke="white" 
                stroke-width="7" 
                fill="none"
                pathLength="1"
                class={`mask-path mask-path-${index}`}
                stroke-dasharray="1"
                stroke-dashoffset="1"
              />
            </mask>
          ))}
        </defs>
        {pathSegments.map((d, index) => (
          <path 
            d={d}
            fill="none" 
            stroke="#3D1F1D" 
            stroke-width="5" 
            stroke-dasharray="15 15"
            mask={`url(#mask-line-${index})`}
          />
        ))}
      </svg>

      <!-- Steps -->
      <div class="relative z-10 w-full h-full">
        {steps.map((step, index) => (
          <div 
            class={`absolute flex flex-col items-center gap-4 step-item step-${index + 1}`}
            style={`
              left: ${step.x}%; 
              top: ${step.y}%;
              transform: translate(-50%, -50%);
            `}
          >
            <div class="relative group cursor-pointer">
              <div class="w-32 h-32 rounded-full border-2 border-gray-900 bg-white flex items-center justify-center transition-transform duration-300 group-hover:scale-110 hover:border-5 group-hover:border-indian-red-500 shadow-lg relative z-10">
                <div class="step-icon text-gray-700 group-hover:text-indian-red-500 transition-colors duration-300" data-icon={step.iconName}>
                  <Icon name={step.iconName} size="48" />
                </div>
              </div>

              <div
                class="absolute w-10 h-10 rounded-full border-2 border-gray-900 bg-white shadow-md z-20 flex items-center justify-center"
                style={`
                  left: 50%;
                  top: 50%;
                  transform: translate(-50%, -50%) rotate(${step.badgeAngle}deg) translate(64px) rotate(-${step.badgeAngle}deg);
                `}
              >
                 <div class="w-3 h-3 bg-indian-red-500 rounded-full"></div>
              </div>
            </div>

            <!-- LABEL ARRIBA -->
            {step.position === "top" && (
              <div class="step-label-container absolute bottom-full mb-4 w-48 text-center transition-opacity duration-300">
                <div class="step-label font-body text-lg font-bold text-gray-800 mb-1">
                  {step.label}
                </div>
                <div class="step-description text-sm text-gray-600">
                  {step.description}
                </div>
              </div>
            )}

            <!-- LABEL ABAJO -->
            {step.position === "bottom" && (
              <div class="step-label-container absolute top-full mt-4 w-48 text-center transition-opacity duration-300">
                <div class="step-label font-body text-lg font-bold text-gray-800 mb-1">
                  {step.label}
                </div>
                <div class="step-description text-sm text-gray-600">
                  {step.description}
                </div>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>

    <!-- Mobile Vertical Layout -->
    <div class="md:hidden flex flex-col gap-12 relative">
      <div class="absolute left-8 top-8 bottom-8 w-1 bg-gray-200 -z-10 border-l-2 border-dashed border-gray-400"></div>

      {steps.map((step) => (
        <div class="flex items-center gap-8 step-item-mobile">
          <div class="relative flex-shrink-0 w-16 h-16 bg-white border-2 border-gray-900 rounded-full flex items-center justify-center z-10 shadow-md">
             <div class="step-icon-mobile text-gray-700" data-icon={step.iconName}>
               <Icon name={step.iconName} size="32" />
             </div>
             <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full border border-gray-900 bg-white flex items-center justify-center">
                <div class="w-2 h-2 bg-indian-red-500 rounded-full"></div>
             </div>
          </div>
          <div>
            <div class="step-label-mobile font-display text-xl font-bold text-gray-900">{step.label}</div>
            <div class="step-description-mobile text-sm text-gray-600 mt-1">{step.description}</div>
          </div>
        </div>
      ))}
    </div>

  </div>
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Mapeo de iconos del sprite
  const iconNames = {
    fire: 'flame',
    ruler: 'ruler',
    wrench: 'corkscrew',
    gear: 'settings',
    shield: 'shield-check',
    camera: 'clapperboard-play',
    map: 'point-on-map',
    ladder: 'alt-arrow-up',
    signal: 'heart-pulse',
    eye: 'eye',
  };

  // Data for the tabs
  const workflows = {
    fire: [
      { label: 'Consulta', description: 'Análisis inicial de necesidades', iconName: iconNames.fire },
      { label: 'Diseño', description: 'Planificación del sistema', iconName: iconNames.ruler },
      { label: 'Instalación', description: 'Montaje de equipos', iconName: iconNames.wrench },
      { label: 'Config', description: 'Configuración y pruebas', iconName: iconNames.gear },
      { label: 'Monitoreo', description: 'Supervisión continua', iconName: iconNames.shield }
    ],
    video: [
      { label: 'Evaluación', description: 'Análisis de requisitos', iconName: iconNames.camera },
      { label: 'Cobertura', description: 'Mapeo de áreas', iconName: iconNames.map },
      { label: 'Montaje', description: 'Instalación de cámaras', iconName: iconNames.ladder },
      { label: 'Red', description: 'Conexión y configuración', iconName: iconNames.signal },
      { label: 'Vigilancia', description: 'Monitoreo activo 24/7', iconName: iconNames.eye }
    ]
  };

  document.addEventListener('DOMContentLoaded', () => {

    // Tab Logic
    const tabs = document.querySelectorAll('.tab-btn');
    const stepIcons = document.querySelectorAll('.step-icon');
    const stepLabels = document.querySelectorAll('.step-label');
    const stepDescriptions = document.querySelectorAll('.step-description');
    const stepIconsMobile = document.querySelectorAll('.step-icon-mobile');
    const stepLabelsMobile = document.querySelectorAll('.step-label-mobile');
    const stepDescriptionsMobile = document.querySelectorAll('.step-description-mobile');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Update active state
        tabs.forEach(t => {
            t.classList.remove('bg-indian-red-500', 'text-white', 'border-indian-red-500');
            t.classList.add('bg-white', 'text-gray-500', 'border-gray-200');
        });
        tab.classList.remove('bg-white', 'text-gray-500', 'border-gray-200');
        tab.classList.add('bg-indian-red-500', 'text-white', 'border-indian-red-500');

        const type = tab.getAttribute('data-type');
        if (!type) return;
        const data = workflows[type as keyof typeof workflows];

        // Animate out
        gsap.to([stepIcons, stepLabels, stepDescriptions, stepIconsMobile, stepLabelsMobile, stepDescriptionsMobile], {
            opacity: 0,
            y: -10,
            duration: 0.2,
            onComplete: () => {
                // Update content
                data.forEach((item, index) => {
                    // Actualizar iconos del sprite (desktop)
                    if(stepIcons[index]) {
                        const useElement = stepIcons[index].querySelector('use');
                        if (useElement) {
                            useElement.setAttribute('href', `/sprite.svg#${item.iconName}`);
                        }
                    }
                    if(stepLabels[index]) stepLabels[index].textContent = item.label;
                    if(stepDescriptions[index]) stepDescriptions[index].textContent = item.description;

                    // Actualizar iconos del sprite (mobile)
                    if(stepIconsMobile[index]) {
                        const useElement = stepIconsMobile[index].querySelector('use');
                        if (useElement) {
                            useElement.setAttribute('href', `/sprite.svg#${item.iconName}`);
                        }
                    }
                    if(stepLabelsMobile[index]) stepLabelsMobile[index].textContent = item.label;
                    if(stepDescriptionsMobile[index]) stepDescriptionsMobile[index].textContent = item.description;
                });

                // Reset and Replay Sequence
                playSequence(false);

                // Animate content back in (both desktop and mobile)
                gsap.to([stepIcons, stepLabels, stepDescriptions, stepIconsMobile, stepLabelsMobile, stepDescriptionsMobile], {
                    opacity: 1,
                    y: 0,
                    duration: 0.3,
                    stagger: 0.05
                });
            }
        });
      });
    });

    // Sequence Animation Function
    function playSequence(withScroll = false) {
      const steps = document.querySelectorAll('.step-item');
      const masks = document.querySelectorAll('.mask-path');
      
      // Kill existing tweens
      gsap.killTweensOf(steps);
      gsap.killTweensOf(masks);

      // Reset state
      gsap.set(steps, { scale: 0, opacity: 0 });
      gsap.set(masks, { strokeDashoffset: 1 });

      const tl = gsap.timeline({
        scrollTrigger: withScroll ? {
          trigger: '#how-to-work',
          start: 'top 60%',
        } : null
      });

      steps.forEach((step, index) => {
        // Animate Step
        tl.to(step, { 
            scale: 1, 
            opacity: 1, 
            duration: 0.5, 
            ease: 'back.out(1.7)' 
        });

        // Animate Line to next step
        if (index < steps.length - 1) {
          const maskPath = document.querySelector(`.mask-path-${index}`);
          if (maskPath) {
            tl.to(maskPath, {
              strokeDashoffset: 0,
              duration: 0.5,
              ease: 'power1.inOut'
            });
          }
        }
      });
    }

    // Initial Play
    playSequence(true);
  });
</script>
