---
import CTAButton from "./CTAButton.astro";


---

<section class="relative w-full mt-24 md:mt-[200px]" id="subscription">
  <div class="relative max-w-6xl mx-auto px-4 -mb-16 md:-mb-24">
    <div
      id="subscription-form"
      class="relative bg-slate-900 z-20 rounded-[40px] p-8 md:p-12 flex flex-col md:flex-row items-center shadow-lg justify-between gap-8 border-4 border-white"
    >
      <div class="flex-1 text-center md:text-left">
        <h3 class="font-display text-2xl md:text-3xl font-bold text-white mb-2">
          Mantente Protegido
        </h3>
        <p class="font-body text-white/80 text-sm md:text-base max-w-md">
          Suscríbete a nuestro boletín para recibir consejos de seguridad y
          ofertas exclusivas.
        </p>
      </div>

      <div class="w-full md:w-auto flex-1 max-w-md">
        <form id="newsletter-form" class="flex flex-col sm:flex-row gap-3">
          <input
            type="email"
            name="email"
            id="email-input"
            placeholder="Tu correo electrónico"
            class="w-full px-5 py-3 rounded-[20px] border-2 focus:outline-none bg-white text-indian-red-900 transition-colors"
            required
          />
          <button
            type="submit"
            id="submit-btn"
            class="px-8 py-3 bg-indian-red-500 cursor-pointer text-white font-bold rounded-[20px] hover:bg-indian-red-600 transition-colors shadow-lg shadow-indian-red-500/30 whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Suscribirse
          </button>
        </form>
        <div id="form-message" class="mt-3 text-sm font-medium hidden"></div>
      </div>
    </div>
    <div
      class="bg-[#FAF8F5] z-18 border-0 corner-shape rounded-[50px] absolute h-[180px] w-[1220px] top-[50px] left-1/2 -translate-x-1/2 p-4 md:p-6"
    >
    </div>
  </div>

  <div class="relative bg-gray-900 pt-40 pb-10 px-6 overflow-hidden">
    <div
      class="bg-[#FAF8F5] z-18 border-0 absolute h-20 w-[150px] right-0 bottom-0 p-4 md:p-6 corner-top-left-shape"
    >
    </div>
    <div
      class="bg-[#FAF8F5] z-18 border-0 absolute h-20 w-[150px] left-0 bottom-0 p-4 md:p-6 corner-top-right-shape"
    >
    </div>
    <div class="absolute inset-0 z-0 opacity-30">
      <img
        src="/img/gvolts/men-install-camera.png"
        alt="Background"
        class="w-full h-full object-cover grayscale"
        loading="lazy"
      />
    </div>
    <div
      class="absolute inset-0 bg-linear-to-t from-gray-700 via-gray-700/20 to-transparent z-1"
    >
    </div>

    <div class="relative z-10 max-w-4xl mx-auto text-center mt-5">
      <h2
        class="font-display text-3xl md:text-5xl font-bold text-white mb-6 leading-tight"
      >
        ¿Listo para asegurar tu tranquilidad?
      </h2>
      <p class="font-body text-gray-400 text-lg mb-10 max-w-2xl mx-auto">
        Nuestros expertos están listos para diseñar la solución perfecta para
        ti. Contáctanos hoy mismo y obtén una evaluación gratuita.
      </p>
      <CTAButton
        text="Contáctanos Ahora"
        variant="primary"
        icon="circle-bottom-up"
        className="group mx-auto"
        size="30"
      />
    </div>
  </div>
</section>

<script>
  import { actions } from "astro:actions";

  const form = document.getElementById("newsletter-form") as HTMLFormElement;
  const emailInput = document.getElementById("email-input") as HTMLInputElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const messageDiv = document.getElementById("form-message") as HTMLDivElement;

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Limpiar mensaje anterior
    messageDiv.classList.add("hidden");
    messageDiv.textContent = "";

    // Validar email
    const email = emailInput.value.trim();
    if (!email) {
      showMessage("Por favor, ingresa tu correo electrónico", "error");
      return;
    }

    // Deshabilitar el botón durante el envío
    submitBtn.disabled = true;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Enviando...";

    try {
      const { data, error } = await actions.newsletter({ email });

      if (error) {
        showMessage(
          error.message || "Error al suscribirse. Intenta nuevamente.",
          "error"
        );
      } else if (data) {
        showMessage(data.message, "success");
        form.reset();
      }
    } catch (err) {
      showMessage("Error de conexión. Por favor, intenta nuevamente.", "error");
      console.error("Error al enviar el formulario:", err);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  function showMessage(message: string, type: "success" | "error") {
    messageDiv.textContent = message;
    messageDiv.classList.remove("hidden", "text-green-600", "text-red-600");
    messageDiv.classList.add(
      type === "success" ? "text-green-600" : "text-red-600"
    );
  }
</script>
