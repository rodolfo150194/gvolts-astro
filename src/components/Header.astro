---
import { Phone, Mail, ChevronDown, Flame, ShieldCheck, Lightbulb, Menu, X, Search } from '@lucide/astro';
import { socials } from "@/data/socials";
---

<header
  class="fixed top-0 left-0 z-50 bg-white transition-all duration-300 w-full max-w-full"
  id="main-header"
>
  <!-- Top Bar: Dark Slate for high contrast -->
  <div
    class="header-top-bar bg-slate-900 text-white py-2 px-4 lg:px-8 hidden md:block"
  >
    <div class="max-w-7xl mx-auto flex justify-between items-center text-sm">
      <div class="flex gap-6">
        <div
          class="flex items-center gap-2 hover:text-indian-red-500 transition-colors cursor-pointer"
        >
          <Phone size={16} />
          <span>+1 (555) 123-4567</span>
        </div>
        <div
          class="flex items-center gap-2 hover:text-indian-red-500 transition-colors cursor-pointer"
        >
          <Mail size={16} />
          <span>info@gvolts.com</span>
        </div>
      </div>
      <div class="flex gap-4">
        {
          socials.map((social) => (
            <a
              href={social.url}
              aria-label={social.ariaLabel}
              class="hover:text-indian-red-500 transition-colors"
              target="_blank"
              rel="noopener noreferrer"
              set:html={social.icon}
            />
          ))
        }
      </div>
    </div>
  </div>

  <!-- Main Header: White with Shadow -->
  <div class="header-second-bar w-full">
    <div class="w-full max-w-full lg:max-w-7xl mx-auto px-4 lg:px-8">
      <div class="flex justify-between items-center h-20 w-full">
        <!-- Logo -->
        <a href="/" class="header-logo shrink-0 flex items-center">
          <img
            src="/img/logo/logo-gvoltscorp.png"
            alt="GVoltscorp Logo"
            class="h-16 w-auto object-contain"
          />
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden md:flex items-center gap-8">
          <a
            href="/"
            class="nav-link header-nav-item text-gray-800 font-medium hover:text-indian-red-500 transition-colors relative py-2"
            >Inicio</a
          >
          <a
            href="/about"
            class="nav-link header-nav-item text-gray-800 font-medium hover:text-indian-red-500 transition-colors relative py-2"
            >Nosotros</a
          >
          <!-- Services Dropdown -->
          <div class="relative group">
            <button
              class="nav-link cursor-pointer header-nav-item text-gray-800 font-medium hover:text-indian-red-500 transition-colors relative py-2 flex items-center gap-1"
            >
              Servicios
              <ChevronDown
                size={16}
                class="transition-transform group-hover:rotate-180"
              />
            </button>

            <!-- Dropdown Menu -->
            <div
              class="absolute top-full left-0 w-64 bg-white shadow-xl rounded-xl overflow-hidden opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 border border-gray-100 z-50"
            >
              <div class="p-2">
                <a
                  href="/services/fire-alarm"
                  class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group/item"
                >
                  <div
                    class="w-8 h-8 rounded-lg bg-indian-red-50 text-indian-red-500 flex items-center justify-center group-hover/item:bg-indian-red-500 group-hover/item:text-white transition-colors"
                  >
                    <Flame size={16} />
                  </div>
                  <div>
                    <span class="block text-sm font-bold text-slate-900"
                      >Alarmas de Incendio</span
                    >
                    <span class="block text-xs text-slate-500 mt-0.5"
                      >Detección y prevención</span
                    >
                  </div>
                </a>
                <a
                  href="/services/security"
                  class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group/item"
                >
                  <div
                    class="w-8 h-8 rounded-lg bg-indian-red-50 text-indian-red-500 flex items-center justify-center group-hover/item:bg-indian-red-500 group-hover/item:text-white transition-colors"
                  >
                    <ShieldCheck size={16} />
                  </div>
                  <div>
                    <span class="block text-sm font-bold text-slate-900"
                      >Seguridad Electrónica</span
                    >
                    <span class="block text-xs text-slate-500 mt-0.5"
                      >CCTV y Control de Acceso</span
                    >
                  </div>
                </a>
                <a
                  href="/services/electricity"
                  class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group/item"
                >
                  <div
                    class="w-8 h-8 rounded-lg bg-indian-red-50 text-indian-red-500 flex items-center justify-center group-hover/item:bg-indian-red-500 group-hover/item:text-white transition-colors"
                  >
                    <Lightbulb size={16} />
                  </div>
                  <div>
                    <span class="block text-sm font-bold text-slate-900"
                      >Electricidad</span
                    >
                    <span class="block text-xs text-slate-500 mt-0.5"
                      >Instalaciones y Mantenimiento</span
                    >
                  </div>
                </a>
              </div>
            </div>
          </div>
          <!-- <a
            href="/projects"
            class="nav-link header-nav-item text-gray-800 font-medium hover:text-indian-red-500 transition-colors relative py-2"
            >Proyectos</a
          > -->
          <!-- Search Button -->
          <button
            id="search-btn-desktop"
            class="text-gray-600 hover:text-indian-red-500 transition-colors cursor-pointer p-2"
            aria-label="Buscar"
          >
            <Search size={20} />
          </button>
          <a
            href="/contact"
            class="header-cta bg-indian-red-500 cursor-pointer text-white px-6 py-2.5 rounded-lg font-bold hover:bg-indian-red-600 transition-[background-color,transform,box-shadow] duration-300 shadow-lg shadow-indian-red-500/30 hover:-translate-y-0.5 active:translate-y-0"
          >
            Contacto
          </a>
        </nav>

        <!-- Mobile Search + Menu Buttons -->
        <div class="flex items-center gap-1 md:hidden">
          <button
            id="search-btn-mobile"
            class="text-gray-800 hover:text-indian-red-500 focus:outline-none p-2 cursor-pointer"
            aria-label="Buscar"
          >
            <Search size={22} />
          </button>
          <button
            id="mobile-menu-btn"
            class="text-gray-800 hover:text-indian-red-500 focus:outline-none p-2"
            aria-label="Toggle menu"
          >
            <Menu size={24} class="menu-icon" />
            <X size={24} class="close-icon hidden" />
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Menu (Hidden by default) -->
  <div
    id="mobile-menu"
    class="md:hidden bg-white border-t border-gray-100 fixed w-full left-0 top-20 shadow-lg transform translate-x-full transition-transform duration-300 z-40 h-[calc(100vh-5rem)] overflow-y-auto"
  >
    <div class="px-4 py-6 space-y-4 flex flex-col items-center min-h-full">
      <a
        href="/"
        class="text-gray-800 font-medium hover:text-indian-red-500 text-lg"
        >Inicio</a
      >
      <a
        href="/about"
        class="text-gray-800 font-medium hover:text-indian-red-500 text-lg"
        >Nosotros</a
      >
      <div class="w-full text-center">
        <span
          class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-2 block"
          >Servicios</span
        >
        <div class="flex flex-col gap-3">
          <a
            href="/services/fire-alarm"
            class="text-gray-800 font-medium hover:text-indian-red-500 text-lg"
            >Alarmas de Incendio</a
          >
          <a
            href="/services/security"
            class="text-gray-800 font-medium hover:text-indian-red-500 text-lg"
            >Seguridad Electrónica</a
          >
          <a
            href="/services/electricity"
            class="text-gray-800 font-medium hover:text-indian-red-500 text-lg"
            >Electricidad</a
          >
        </div>
      </div>
      <a
        href="/contact"
        class="text-gray-800 font-medium hover:text-indian-red-500 text-lg"
        >Contacto</a
      >

      <!-- Mobile Socials -->
      <div
        class="flex gap-6 pt-4 border-t border-gray-100 w-full justify-center mt-2"
      >
        {
          socials.map((social) => (
            <a
              href={social.url}
              aria-label={social.ariaLabel}
              class="text-indian-red-500 hover:text-indian-red-600"
              target="_blank"
              rel="noopener noreferrer"
              set:html={social.icon}
            />
          ))
        }
      </div>
    </div>
  </div>
</header>

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-100 hidden">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <!-- Modal Content -->
  <div class="relative flex items-start justify-center pt-24 px-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden">
      <!-- Search Input -->
      <div class="flex items-center gap-3 px-5 py-4 border-b border-gray-100">
        <Search size={20} class="text-gray-400 shrink-0" />
        <input
          id="search-input"
          type="text"
          placeholder="Buscar en el sitio..."
          class="w-full text-lg outline-none text-gray-800 placeholder:text-gray-400"
          autocomplete="off"
        />
        <kbd class="hidden sm:inline-block text-xs text-gray-400 border border-gray-200 rounded px-1.5 py-0.5">ESC</kbd>
      </div>
      <!-- Results -->
      <div id="search-results" class="max-h-80 overflow-y-auto p-2">
        <p class="text-sm text-gray-400 text-center py-6">Escribe para buscar...</p>
      </div>
    </div>
  </div>
</div>

<!-- Spacer to compensate for fixed header height -->
<div id="header-spacer" class="w-full"></div>

<style>
  /* Ensure header doesn't overflow on mobile */
  #main-header {
    width: 100%;
    max-width: 100vw;
  }

  .header-second-bar,
  .header-top-bar {
    width: 100%;
    max-width: 100vw;
    box-sizing: border-box;
  }

  /* Animated underline for desktop links */
  .nav-link::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background-color: #cd5c5c; /* indian-red-500 */
    transition: width 0.3s ease;
  }

  .nav-link:hover::after {
    width: 100%;
  }

  /* Mobile responsive adjustments */
  @media (max-width: 768px) {
    #main-header,
    .header-second-bar,
    .header-top-bar {
      width: 100vw;
      max-width: 100vw;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Fixed header: set spacer height to match header
    const header = document.getElementById("main-header");
    const spacer = document.getElementById("header-spacer");
    function updateSpacer() {
      if (header && spacer) {
        spacer.style.height = header.offsetHeight + "px";
      }
    }
    updateSpacer();
    window.addEventListener("resize", updateSpacer);

    // Shadow on scroll
    window.addEventListener("scroll", () => {
      if (window.scrollY > 10) {
        header?.classList.add("shadow-lg");
      } else {
        header?.classList.remove("shadow-lg");
      }
    });

    // Mobile Menu Toggle
    const menuBtn = document.getElementById("mobile-menu-btn");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuIcon = menuBtn?.querySelector(".menu-icon");
    const closeIcon = menuBtn?.querySelector(".close-icon");
    let isMenuOpen = false;

    menuBtn?.addEventListener("click", () => {
      isMenuOpen = !isMenuOpen;

      if (isMenuOpen) {
        // Open Menu - slide from right
        mobileMenu?.classList.remove("translate-x-full");
        mobileMenu?.classList.add("translate-x-0");
        menuIcon?.classList.add("hidden");
        closeIcon?.classList.remove("hidden");
        document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
      } else {
        // Close Menu - slide to right
        mobileMenu?.classList.remove("translate-x-0");
        mobileMenu?.classList.add("translate-x-full");
        menuIcon?.classList.remove("hidden");
        closeIcon?.classList.add("hidden");
        document.body.style.overflow = ''; // Restore scrolling
      }
    });

    // Close mobile menu when clicking a link
    const mobileLinks = mobileMenu?.querySelectorAll("a");
    mobileLinks?.forEach((link) => {
      link.addEventListener("click", () => {
        isMenuOpen = false;
        mobileMenu?.classList.remove("translate-x-0");
        mobileMenu?.classList.add("translate-x-full");
        menuIcon?.classList.remove("hidden");
        closeIcon?.classList.add("hidden");
        document.body.style.overflow = '';
      });
    });
  });

  // ── Site Search ──
  const searchIndex = [
    { title: "Inicio", description: "Página principal de GVoltscorp. Sistemas de seguridad, alarmas contra incendios, videovigilancia y servicios eléctricos profesionales.", url: "/", keywords: "inicio home principal gvolts seguridad protección" },
    { title: "Nosotros", description: "Conoce nuestro equipo, experiencia y compromiso. Más de 10 años protegiendo hogares y negocios con certificaciones UL y NFPA.", url: "/about", keywords: "nosotros about equipo experiencia certificaciones historia empresa" },
    { title: "Contacto", description: "Solicita una evaluación gratuita y cotización sin compromiso. Respuesta en 24 horas. Servicio de emergencia 24/7.", url: "/contact", keywords: "contacto cotización evaluación teléfono email emergencia" },
    { title: "Alarmas de Incendio", description: "Sistemas de detección y alarmas contra incendios certificados NFPA. Detectores de humo, paneles de control, monitoreo 24/7.", url: "/services/fire-alarm", keywords: "alarma incendio fuego detector humo panel NFPA fire sprinkler protección contra incendios" },
    { title: "Seguridad Electrónica", description: "Cámaras CCTV, control de acceso, videovigilancia inteligente. Monitoreo remoto en tiempo real para hogares y negocios.", url: "/services/security", keywords: "seguridad cámaras CCTV vigilancia control acceso monitoreo video surveillance" },
    { title: "Electricidad", description: "Instalaciones eléctricas residenciales y comerciales. Mantenimiento, reparaciones y diseño de sistemas eléctricos certificados.", url: "/services/electricity", keywords: "electricidad eléctrico instalación cableado panel tablero mantenimiento reparación circuito" },
  ];

  const modal = document.getElementById("search-modal");
  const backdrop = document.getElementById("search-backdrop");
  const searchInput = document.getElementById("search-input") as HTMLInputElement;
  const resultsContainer = document.getElementById("search-results");

  function openSearch() {
    modal?.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    setTimeout(() => searchInput?.focus(), 50);
  }

  function closeSearch() {
    modal?.classList.add("hidden");
    document.body.style.overflow = "";
    if (searchInput) searchInput.value = "";
    if (resultsContainer) resultsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">Escribe para buscar...</p>';
  }

  // Open search from buttons
  document.getElementById("search-btn-desktop")?.addEventListener("click", openSearch);
  document.getElementById("search-btn-mobile")?.addEventListener("click", openSearch);

  // Close on backdrop click or ESC
  backdrop?.addEventListener("click", closeSearch);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal?.classList.contains("hidden")) closeSearch();
    // Ctrl+K / Cmd+K shortcut
    if ((e.ctrlKey || e.metaKey) && e.key === "k") {
      e.preventDefault();
      modal?.classList.contains("hidden") ? openSearch() : closeSearch();
    }
  });

  // Search logic
  searchInput?.addEventListener("input", () => {
    const query = searchInput.value.trim().toLowerCase();
    if (!resultsContainer) return;

    if (!query) {
      resultsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">Escribe para buscar...</p>';
      return;
    }

    const terms = query.split(/\s+/);
    const results = searchIndex.filter((page) => {
      const haystack = `${page.title} ${page.description} ${page.keywords}`.toLowerCase();
      return terms.every((term) => haystack.includes(term));
    });

    if (results.length === 0) {
      resultsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-6">No se encontraron resultados</p>';
      return;
    }

    resultsContainer.innerHTML = results
      .map(
        (r) => `<a href="${r.url}" class="flex flex-col gap-1 px-4 py-3 rounded-xl hover:bg-slate-50 transition-colors group">
          <span class="font-semibold text-gray-800 group-hover:text-indian-red-500 transition-colors">${highlight(r.title, terms)}</span>
          <span class="text-sm text-gray-500 line-clamp-2">${highlight(r.description, terms)}</span>
        </a>`
      )
      .join("");
  });

  function highlight(text: string, terms: string[]) {
    let result = text;
    for (const term of terms) {
      const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "gi");
      result = result.replace(regex, '<mark class="bg-indian-red-100 text-indian-red-700 rounded px-0.5">$1</mark>');
    }
    return result;
  }
</script>
